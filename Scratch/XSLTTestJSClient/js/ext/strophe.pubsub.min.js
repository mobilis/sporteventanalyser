Strophe.Builder.prototype.form=function(e,t){var n=this.node.appendChild(Strophe.xmlElement("x",{xmlns:"jabber:x:data",type:"submit"}));n.appendChild(Strophe.xmlElement("field",{"var":"FORM_TYPE",type:"hidden"})).appendChild(Strophe.xmlElement("value")).appendChild(Strophe.xmlTextNode(e));for(var r in t){n.appendChild(Strophe.xmlElement("field",{"var":r})).appendChild(Strophe.xmlElement("value")).appendChild(Strophe.xmlTextNode(t[r]))}return this};Strophe.Builder.prototype.list=function(e,t){for(var n=0;n<t.length;++n){this.c(e,t[n].attrs);this.node.appendChild(t[n].data.cloneNode?t[n].data.cloneNode(true):Strophe.xmlTextNode(t[n].data));this.up()}return this};Strophe.Builder.prototype.children=function(e){var t,n;for(t in e){if(!e.hasOwnProperty(t))continue;n=e[t];if(Array.isArray(n)){this.list(t,n)}else if(typeof n==="string"){this.c(t,{},n)}else if(typeof n==="number"){this.c(t,{},""+n)}else if(typeof n==="object"){this.c(t).children(n).up()}else{this.c(t).up()}}return this};Strophe.addConnectionPlugin("pubsub",{_connection:null,_autoService:true,service:null,jid:null,init:function(e){this._connection=e;Strophe.addNamespace("PUBSUB","http://jabber.org/protocol/pubsub");Strophe.addNamespace("PUBSUB_SUBSCRIBE_OPTIONS",Strophe.NS.PUBSUB+"#subscribe_options");Strophe.addNamespace("PUBSUB_ERRORS",Strophe.NS.PUBSUB+"#errors");Strophe.addNamespace("PUBSUB_EVENT",Strophe.NS.PUBSUB+"#event");Strophe.addNamespace("PUBSUB_OWNER",Strophe.NS.PUBSUB+"#owner");Strophe.addNamespace("PUBSUB_AUTO_CREATE",Strophe.NS.PUBSUB+"#auto-create");Strophe.addNamespace("PUBSUB_PUBLISH_OPTIONS",Strophe.NS.PUBSUB+"#publish-options");Strophe.addNamespace("PUBSUB_NODE_CONFIG",Strophe.NS.PUBSUB+"#node_config");Strophe.addNamespace("PUBSUB_CREATE_AND_CONFIGURE",Strophe.NS.PUBSUB+"#create-and-configure");Strophe.addNamespace("PUBSUB_SUBSCRIBE_AUTHORIZATION",Strophe.NS.PUBSUB+"#subscribe_authorization");Strophe.addNamespace("PUBSUB_GET_PENDING",Strophe.NS.PUBSUB+"#get-pending");Strophe.addNamespace("PUBSUB_MANAGE_SUBSCRIPTIONS",Strophe.NS.PUBSUB+"#manage-subscriptions");Strophe.addNamespace("PUBSUB_META_DATA",Strophe.NS.PUBSUB+"#meta-data");Strophe.addNamespace("ATOM","http://www.w3.org/2005/Atom");if(e.disco)e.disco.addFeature(Strophe.NS.PUBSUB)},statusChanged:function(e,t){var n=this._connection;if(this._autoService&&e===Strophe.Status.CONNECTED){this.service="pubsub."+Strophe.getDomainFromJid(n.jid);this.jid=n.jid}},connect:function(e,t){var n=this._connection;if(t===undefined){t=e;e=undefined}this.jid=e||n.jid;this.service=t||null;this._autoService=false},createNode:function(e,t,n){var r=this._connection;var i=r.getUniqueId("pubsubcreatenode");var s=$iq({from:this.jid,to:this.service,type:"set",id:i}).c("pubsub",{xmlns:Strophe.NS.PUBSUB}).c("create",{node:e});if(t){s.up().c("configure").form(Strophe.NS.PUBSUB_NODE_CONFIG,t)}r.addHandler(n,null,"iq",null,i,null);r.send(s.tree());return i},deleteNode:function(e,t){var n=this._connection;var r=n.getUniqueId("pubsubdeletenode");var i=$iq({from:this.jid,to:this.service,type:"set",id:r}).c("pubsub",{xmlns:Strophe.NS.PUBSUB_OWNER}).c("delete",{node:e});n.addHandler(t,null,"iq",null,r,null);n.send(i.tree());return r},discoverNodes:function(e,t,n){var r=$iq({from:this.jid,to:this.service,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});return this._connection.sendIQ(r.tree(),e,t,n)},getConfig:function(e,t){var n=this._connection;var r=n.getUniqueId("pubsubconfigurenode");var i=$iq({from:this.jid,to:this.service,type:"get",id:r}).c("pubsub",{xmlns:Strophe.NS.PUBSUB_OWNER}).c("configure",{node:e});n.addHandler(t,null,"iq",null,r,null);n.send(i.tree());return r},getDefaultNodeConfig:function(e){var t=this._connection;var n=t.getUniqueId("pubsubdefaultnodeconfig");var r=$iq({from:this.jid,to:this.service,type:"get",id:n}).c("pubsub",{xmlns:Strophe.NS.PUBSUB_OWNER}).c("default");t.addHandler(e,null,"iq",null,n,null);t.send(r.tree());return n},subscribe:function(e,t,n,r,i,s){var o=this._connection;var u=o.getUniqueId("subscribenode");var a=this.jid;if(s)a=Strophe.getBareJidFromJid(a);var f=$iq({from:this.jid,to:this.service,type:"set",id:u}).c("pubsub",{xmlns:Strophe.NS.PUBSUB}).c("subscribe",{node:e,jid:a});if(t){f.up().c("options").form(Strophe.NS.PUBSUB_SUBSCRIBE_OPTIONS,t)}o.addHandler(n,null,"message",null,null,null);o.sendIQ(f.tree(),r,i);return u},unsubscribe:function(e,t,n,r,i){var s=this._connection;var o=s.getUniqueId("pubsubunsubscribenode");var u=$iq({from:this.jid,to:this.service,type:"set",id:o}).c("pubsub",{xmlns:Strophe.NS.PUBSUB}).c("unsubscribe",{node:e,jid:t});if(n)u.attrs({subid:n});s.sendIQ(u.tree(),r,i);return o},publish:function(e,t,n){var r=this._connection;var i=r.getUniqueId("pubsubpublishnode");var s=$iq({from:this.jid,to:this.service,type:"set",id:i}).c("pubsub",{xmlns:Strophe.NS.PUBSUB}).c("publish",{node:e,jid:this.jid}).list("item",t);r.addHandler(n,null,"iq",null,i,null);r.send(s.tree());return i},items:function(e,t,n,r){var i=$iq({from:this.jid,to:this.service,type:"get"}).c("pubsub",{xmlns:Strophe.NS.PUBSUB}).c("items",{node:e});return this._connection.sendIQ(i.tree(),t,n,r)},getSubscriptions:function(e,t){var n=this._connection;var r=n.getUniqueId("pubsubsubscriptions");var i=$iq({from:this.jid,to:this.service,type:"get",id:r}).c("pubsub",{xmlns:Strophe.NS.PUBSUB}).c("subscriptions");n.addHandler(e,null,"iq",null,r,null);n.send(i.tree());return r},getNodeSubscriptions:function(e,t){var n=this._connection;var r=n.getUniqueId("pubsubsubscriptions");var i=$iq({from:this.jid,to:this.service,type:"get",id:r}).c("pubsub",{xmlns:Strophe.NS.PUBSUB_OWNER}).c("subscriptions",{node:e});n.addHandler(t,null,"iq",null,r,null);n.send(i.tree());return r},getSubOptions:function(e,t,n){var r=this._connection;var i=r.getUniqueId("pubsubsuboptions");var s=$iq({from:this.jid,to:this.service,type:"get",id:i}).c("pubsub",{xmlns:Strophe.NS.PUBSUB}).c("options",{node:e,jid:this.jid});if(t)s.attrs({subid:t});r.addHandler(n,null,"iq",null,i,null);r.send(s.tree());return i},getAffiliations:function(e,t){var n=this._connection;var r=n.getUniqueId("pubsubaffiliations");if(typeof e==="function"){t=e;e=undefined}var i={},s={xmlns:Strophe.NS.PUBSUB};if(e){i.node=e;s={xmlns:Strophe.NS.PUBSUB_OWNER}}var o=$iq({from:this.jid,to:this.service,type:"get",id:r}).c("pubsub",s).c("affiliations",i);n.addHandler(t,null,"iq",null,r,null);n.send(o.tree());return r},setAffiliation:function(e,t,n,r){var i=this._connection;var s=thiat.getUniqueId("pubsubaffiliations");var o=$iq({from:this.jid,to:this.service,type:"set",id:s}).c("pubsub",{xmlns:Strophe.NS.PUBSUB_OWNER}).c("affiliations",{node:e}).c("affiliation",{jid:t,affiliation:n});i.addHandler(r,null,"iq",null,s,null);i.send(o.tree());return s},publishAtom:function(e,t,n){if(!Array.isArray(t))t=[t];var r,i,s=[];for(r=0;r<t.length;r++){i=t[r];i.updated=i.updated||(new Date).toISOString();if(i.published&&i.published.toISOString)i.published=i.published.toISOString();s.push({data:$build("entry",{xmlns:Strophe.NS.ATOM}).children(i).tree(),attrs:i.id?{id:i.id}:{}})}return this.publish(e,s,n)}})